<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur JWPUB</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }
        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .form-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        textarea {
            min-height: 120px;
            font-family: monospace;
            resize: vertical;
        }
        .file-input {
            display: none;
        }
        .file-label {
            display: inline-block;
            padding: 12px 24px;
            background: #f5f5f5;
            border: 2px dashed #d0d0d0;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            width: 100%;
        }
        .file-label:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 14px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 13px;
            color: #666;
        }
        .preview strong {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìñ G√©n√©rateur JWPUB</h1>
        <p class="subtitle">Transformez votre index biblique en publication JW Library</p>

        <div class="form-group">
            <label>Titre de la publication</label>
            <input type="text" id="pubTitle" value="Mon Index Biblique" placeholder="Ex: Versets pour la vie chr√©tienne">
        </div>

        <div class="form-group">
            <label>Code/Symbole</label>
            <input type="text" id="pubSymbol" value="mib" placeholder="Ex: scl" maxlength="10">
        </div>

        <div class="form-group">
            <label>Vos donn√©es JSON</label>
            <textarea id="jsonData" placeholder='{"categories": [...]}'></textarea>
            <small style="color: #666;">Exportez vos donn√©es depuis l'application et collez-les ici</small>
        </div>

        <div class="form-group">
            <label>Image de couverture (optionnel)</label>
            <input type="file" id="coverImage" class="file-input" accept="image/*">
            <label for="coverImage" class="file-label">
                üì∑ Choisir une image (JPG/PNG)
            </label>
        </div>

        <button class="btn" id="generateBtn" onclick="generateJWPUB()">
            üöÄ G√©n√©rer le fichier JWPUB
        </button>

        <div class="status" id="status"></div>

        <div class="preview" style="display: none;" id="preview">
            <strong>Aper√ßu :</strong><br>
            <span id="previewContent"></span>
        </div>
    </div>

    <script>
        let SQL;
        let coverImageData = null;

        // Charger SQL.js
        initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        }).then(sql => {
            SQL = sql;
            showStatus('‚úÖ Pr√™t √† g√©n√©rer !', 'success');
        });

        // G√©rer l'upload d'image
        document.getElementById('coverImage').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    coverImageData = new Uint8Array(ev.target.result);
                    document.querySelector('.file-label').textContent = `‚úÖ ${file.name}`;
                };
                reader.readAsArrayBuffer(file);
            }
        });

        // Afficher un message de statut
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        // Fonction principale de g√©n√©ration
        async function generateJWPUB() {
            try {
                showStatus('‚è≥ G√©n√©ration en cours...', 'info');
                document.getElementById('generateBtn').disabled = true;

                // R√©cup√©rer les donn√©es
                const title = document.getElementById('pubTitle').value.trim();
                const symbol = document.getElementById('pubSymbol').value.trim().toLowerCase();
                const jsonText = document.getElementById('jsonData').value.trim();

                if (!title || !symbol || !jsonText) {
                    showStatus('‚ùå Veuillez remplir tous les champs requis', 'error');
                    document.getElementById('generateBtn').disabled = false;
                    return;
                }

                // Parser le JSON
                let data;
                try {
                    data = JSON.parse(jsonText);
                } catch (e) {
                    showStatus('‚ùå Format JSON invalide', 'error');
                    document.getElementById('generateBtn').disabled = false;
                    return;
                }

                // Cr√©er la base de donn√©es
                const db = new SQL.Database();
                createDatabase(db, title, symbol, data);

                // Exporter la base
                const dbData = db.export();
                const dbBlob = new Uint8Array(dbData);

                // Cr√©er le manifest
                const manifest = createManifest(title, symbol, dbBlob.length);

                // Cr√©er le ZIP (JWPUB)
                const zip = new JSZip();
                
                // Ajouter le manifest
                zip.file('manifest.json', JSON.stringify(manifest, null, 2));

                // Cr√©er le dossier contents
                const contents = zip.folder('contents');
                
                // Ajouter la base de donn√©es
                contents.file(`${symbol}_F.db`, dbBlob);

                // Ajouter l'image si pr√©sente
                if (coverImageData) {
                    contents.file('1107001000_univ_sqr.jpg', coverImageData);
                }

                // G√©n√©rer le fichier
                const jwpubBlob = await zip.generateAsync({ type: 'blob' });

                // T√©l√©charger
                const link = document.createElement('a');
                link.href = URL.createObjectURL(jwpubBlob);
                link.download = `${symbol}_F.jwpub`;
                link.click();

                showStatus('‚úÖ Fichier JWPUB g√©n√©r√© avec succ√®s !', 'success');

                // Afficher l'aper√ßu
                const preview = document.getElementById('preview');
                const previewContent = document.getElementById('previewContent');
                previewContent.innerHTML = `
                    Nom: <strong>${symbol}_F.jwpub</strong><br>
                    Titre: <strong>${title}</strong><br>
                    Cat√©gories: <strong>${data.categories?.length || 0}</strong><br>
                    Taille: <strong>${(jwpubBlob.size / 1024).toFixed(2)} KB</strong>
                `;
                preview.style.display = 'block';

            } catch (error) {
                console.error(error);
                showStatus('‚ùå Erreur: ' + error.message, 'error');
            } finally {
                document.getElementById('generateBtn').disabled = false;
            }
        }

        // Cr√©er la structure de base de donn√©es
        function createDatabase(db, title, symbol, data) {
            // Cr√©er les tables principales
            createTables(db);

            // Ins√©rer les donn√©es de publication
            db.run(`
                INSERT INTO Publication (
                    PublicationId, Type, Title, TitleRich, ShortTitle, DisplayTitle,
                    ReferenceTitle, UndatedReferenceTitle, Symbol, UndatedSymbol,
                    UniqueSymbol, EnglishSymbol, UniqueEnglishSymbol, Year,
                    MepsLanguageIndex, PublicationType, VersionNumber
                ) VALUES (
                    1, 9, ?, ?, ?, ?,
                    ?, ?, ?, ?,
                    ?, ?, ?, 2023,
                    3, 'Book', 1
                )
            `, [title, title, title, title, title, title, symbol, symbol, symbol, symbol, symbol]);

            // Ins√©rer la cat√©gorie
            db.run('INSERT INTO PublicationCategory (PublicationId, Category) VALUES (1, "bk")');

            // Cr√©er les documents √† partir des cat√©gories
            let docId = 1;
            data.categories.forEach((cat, idx) => {
                // Document pour la cat√©gorie
                const content = generateHTMLContent(cat);
                db.run(`
                    INSERT INTO Document (
                        DocumentId, PublicationId, Class, Type, Title, TitleRich,
                        Content, SectionNumber
                    ) VALUES (?, 1, 'article', 0, ?, ?, ?, ?)
                `, [docId, cat.name, cat.name, stringToBlob(content), idx + 1]);
                docId++;
            });
        }

        // G√©n√©rer le contenu HTML d'une cat√©gorie
        function generateHTMLContent(category) {
            let html = `<div class="section"><h2>${category.name}</h2>`;
            
            category.subcategories?.forEach(sub => {
                html += `<div class="subsection"><h3>${sub.name}</h3><ul>`;
                sub.verses?.forEach(verse => {
                    html += `<li><strong>${verse.ref}</strong>`;
                    if (verse.note) html += ` - ${verse.note}`;
                    html += `</li>`;
                });
                html += `</ul></div>`;
            });
            
            html += `</div>`;
            return html;
        }

        // Convertir string en blob
        function stringToBlob(str) {
            const encoder = new TextEncoder();
            return encoder.encode(str);
        }

        // Cr√©er le manifest.json
        function createManifest(title, symbol, dbSize) {
            const timestamp = new Date().toISOString();
            return {
                name: `${symbol}_F.jwpub`,
                hash: generateHash(),
                timestamp: timestamp,
                version: 1,
                expandedSize: dbSize + 50000,
                contentFormat: "z-a",
                htmlValidated: true,
                mepsPlatformVersion: 2.1,
                mepsBuildNumber: 13373,
                publication: {
                    fileName: `${symbol}_F.db`,
                    type: 9,
                    title: title,
                    shortTitle: title,
                    displayTitle: `${title} (${symbol})`,
                    referenceTitle: title,
                    undatedReferenceTitle: title,
                    titleRich: title,
                    displayTitleRich: `${title} (${symbol})`,
                    referenceTitleRich: title,
                    undatedReferenceTitleRich: title,
                    symbol: symbol,
                    uniqueEnglishSymbol: symbol,
                    uniqueSymbol: symbol,
                    undatedSymbol: symbol,
                    englishSymbol: symbol,
                    language: 3,
                    hash: generateHash(),
                    timestamp: timestamp,
                    minPlatformVersion: 1,
                    schemaVersion: 8,
                    year: 2023,
                    issueId: 0,
                    issueNumber: 0,
                    variation: "",
                    publicationType: "Book",
                    rootSymbol: symbol,
                    rootYear: 2023,
                    rootLanguage: 0,
                    images: [],
                    categories: ["bk"],
                    attributes: [],
                    issueAttributes: [],
                    issueProperties: {
                        title: "",
                        undatedTitle: "",
                        coverTitle: "",
                        titleRich: "",
                        undatedTitleRich: "",
                        coverTitleRich: "",
                        symbol: "",
                        undatedSymbol: ""
                    }
                }
            };
        }

        // G√©n√©rer un hash simple
        function generateHash() {
            return Array.from({length: 40}, () => Math.floor(Math.random() * 16).toString(16)).join('');
        }

        // Cr√©er toutes les tables SQLite n√©cessaires
        function createTables(db) {
            // Table Publication
            db.run(`CREATE TABLE Publication (
                PublicationId INTEGER PRIMARY KEY,
                VersionNumber INTEGER,
                Type INTEGER,
                Title TEXT,
                TitleRich TEXT,
                RootSymbol TEXT,
                RootYear INTEGER,
                RootMepsLanguageIndex INTEGER,
                ShortTitle TEXT,
                ShortTitleRich TEXT,
                DisplayTitle TEXT,
                DisplayTitleRich TEXT,
                ReferenceTitle TEXT,
                ReferenceTitleRich TEXT,
                UndatedReferenceTitle TEXT,
                UndatedReferenceTitleRich TEXT,
                Symbol TEXT NOT NULL,
                UndatedSymbol TEXT,
                UniqueSymbol TEXT,
                EnglishSymbol TEXT,
                UniqueEnglishSymbol TEXT NOT NULL,
                IssueTagNumber TEXT,
                IssueNumber INTEGER,
                Variation TEXT,
                Year INTEGER NOT NULL,
                VolumeNumber INTEGER,
                MepsLanguageIndex INTEGER NOT NULL,
                PublicationType TEXT,
                PublicationCategorySymbol TEXT,
                BibleVersionForCitations TEXT,
                HasPublicationChapterNumbers BOOLEAN,
                HasPublicationSectionNumbers BOOLEAN,
                FirstDatedTextDateOffset DATE,
                LastDatedTextDateOffset DATE,
                MepsBuildNumber INTEGER
            )`);

            // Table PublicationCategory
            db.run(`CREATE TABLE PublicationCategory (
                PublicationCategoryId INTEGER PRIMARY KEY,
                PublicationId INTEGER REFERENCES Publication (PublicationId),
                Category TEXT
            )`);

            // Table Document
            db.run(`CREATE TABLE Document (
                DocumentId INTEGER PRIMARY KEY,
                PublicationId INTEGER REFERENCES Publication (PublicationId),
                MepsDocumentId INTEGER,
                MepsLanguageIndex INTEGER,
                Class TEXT,
                Type INTEGER,
                SectionNumber INTEGER,
                ChapterNumber INTEGER,
                Title TEXT,
                TitleRich TEXT,
                TocTitle TEXT,
                TocTitleRich TEXT,
                ContextTitle TEXT,
                ContextTitleRich TEXT,
                FeatureTitle TEXT,
                FeatureTitleRich TEXT,
                Subtitle TEXT,
                SubtitleRich TEXT,
                FeatureSubtitle TEXT,
                FeatureSubtitleRich TEXT,
                Content BLOB,
                FirstFootnoteId INTEGER,
                LastFootnoteId INTEGER,
                FirstBibleCitationId INTEGER,
                LastBibleCitationId INTEGER,
                ParagraphCount INTEGER,
                HasMediaLinks BOOLEAN,
                HasLinks BOOLEAN,
                FirstPageNumber INTEGER,
                LastPageNumber INTEGER,
                ContentLength INTEGER,
                PreferredPresentation TEXT,
                ContentReworkedDate TEXT,
                HasPronunciationGuide BOOLEAN
            )`);

            // Cr√©er les autres tables n√©cessaires
            const otherTables = [
                'PublicationAttribute', 'PublicationIssueAttribute', 'PublicationIssueProperty',
                'PublicationYear', 'Asset', 'Hyperlink', 'InternalLink'
            ];

            otherTables.forEach(table => {
                db.run(`CREATE TABLE ${table} (${table}Id INTEGER PRIMARY KEY)`);
            });
        }
    </script>
</body>
</html>