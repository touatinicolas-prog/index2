<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a1a">

    <link rel="apple-touch-icon" href="icon.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icon.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon.png">
    
    <title>Mon Index Biblique</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #e8e8e8;
            --text-secondary: #b8b8b8;
            --accent: #4a90e2;
            --border: #4a4a4a;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        .header {
            background: var(--bg-secondary);
            padding: 20px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header h1 { font-size: 22px; font-weight: 600; }
        .mode-toggle {
            padding: 8px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .search-input {
            width: 100%;
            padding: 10px 15px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
            margin-bottom: 12px;
        }
        .controls { display: flex; gap: 8px; flex-wrap: wrap; }
        .controls.hidden { display: none; }
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            flex: 1;
            min-width: 100px;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: #2d7d46; color: white; }
        .btn-info { background: #357abd; color: white; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .container { padding-bottom: 40px; }
        .category-card { background: var(--bg-secondary); border-bottom: 1px solid var(--border); }
        .category-card.dragging { opacity: 0.5; }
        .category-header {
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .category-title-wrapper { display: flex; align-items: center; gap: 12px; flex: 1; }
        .category-title { font-size: 18px; font-weight: 600; }
        .drag-handle {
            cursor: grab;
            padding: 4px 8px;
            user-select: none;
            font-size: 18px;
        }
        .drag-handle:active { cursor: grabbing; }
        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
            padding: 4px 8px;
        }
        .icon-btn.hidden { display: none; }
        .chevron { color: var(--text-secondary); font-size: 14px; }
        .category-content { display: none; background: var(--bg-primary); }
        .category-content.expanded { display: block; }
        .subcategory { 
            padding: 16px 20px 16px 40px; 
            border-bottom: 1px solid var(--border);
            position: relative;
        }
        .subcategory.level-2 { padding-left: 60px; }
        .subcategory.dragging { opacity: 0.5; }
        .subcategory.drag-over { border-top: 3px solid var(--accent); }
        .subcategory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .subcategory-title-wrapper { display: flex; align-items: center; gap: 10px; flex: 1; }
        .subcategory-title { font-size: 16px; font-weight: 500; color: var(--accent); }
        .subcategory-content { display: none; margin-top: 8px; }
        .subcategory-content.expanded { display: block; }
        .verse-item {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .verse-item.dragging { opacity: 0.5; }
        .verse-item.drag-over { border-top: 2px solid var(--accent); }
        .verse-content { flex: 1; display: flex; align-items: flex-start; gap: 8px; }
        .verse-ref {
            color: var(--accent);
            font-weight: 500;
            text-decoration: none;
            display: block;
            margin-bottom: 6px;
            font-size: 15px;
        }
        .verse-note { color: var(--text-secondary); font-size: 14px; line-height: 1.5; }
        .highlight { background-color: #7a5d00; color: #fff; padding: 2px 4px; border-radius: 2px; }
        .context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            padding: 8px 0;
            z-index: 1000;
            min-width: 200px;
        }
        .context-menu-item { padding: 12px 16px; cursor: pointer; color: var(--text-primary); font-size: 15px; }
        .context-menu-item:active { background: var(--bg-tertiary); }
        .context-menu-item.danger { color: #e74c3c; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            padding: 20px;
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            border: 1px solid var(--border);
        }
        .modal-title { font-size: 20px; font-weight: 600; margin-bottom: 20px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; }
        .form-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 16px;
        }
        .form-input:focus { outline: none; border-color: var(--accent); }
        .modal-buttons { display: flex; gap: 10px; margin-top: 24px; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .splash {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.3s;
        }
        .splash.hide { opacity: 0; pointer-events: none; }
        .splash-icon {
            width: 120px;
            height: 120px;
            background: var(--accent);
            border-radius: 27px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin-bottom: 20px;
        }
        .page-view {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 200;
            overflow-y: auto;
        }
        .page-view.active { display: block; }
        .page-header {
            background: var(--bg-secondary);
            padding: 20px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 201;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .back-btn {
            background: transparent;
            border: none;
            color: var(--accent);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .page-title {
            font-size: 20px;
            font-weight: 600;
            flex: 1;
        }
        .page-content { padding: 20px; }
    </style>
</head>
    
<body>
    <div class="splash" id="splash">
        <div class="splash-icon">
            <img src="icon.png" alt="IB" style="width: 100%; height: 100%; border-radius: 27px;">
        </div>
        <div style="color: var(--text-secondary);">Mon Index Biblique</div>
    </div>
    
    <div class="header">
        <div class="header-top">
            <h1>Mon Index Biblique</h1>
            <button class="mode-toggle" onclick="toggleMode()" id="modeBtn">Mode Lecture</button>
        </div>
        <input type="text" class="search-input" id="searchInput" placeholder="Rechercher...">
        <div class="controls" id="controls">
            <button class="btn btn-primary" onclick="openModal('addCategoryModal')">+ Catégorie</button>
            <button class="btn btn-success" onclick="exportData()">Exporter</button>
            <button class="btn btn-info" onclick="document.getElementById('importFile').click()">Importer</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
        </div>
    </div>
    
    <div class="container">
        <div id="categoriesContainer"></div>
        <div class="empty-state" id="emptyState" style="display:none;">
            <h2>Aucune catégorie</h2>
            <p style="margin-top: 10px;">Cliquez sur "+ Catégorie" pour commencer</p>
        </div>
    </div>

    <div id="contextMenu"></div>
    
    <div class="modal" id="addCategoryModal">
        <div class="modal-content">
            <div class="modal-title">Nouvelle Catégorie</div>
            <div class="form-group">
                <label class="form-label">Nom</label>
                <input type="text" class="form-input" id="categoryName">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="addCategory()">Ajouter</button>
                <button class="btn btn-secondary" onclick="closeModal('addCategoryModal')">Annuler</button>
            </div>
        </div>
    </div>

    <div class="modal" id="editCategoryModal">
        <div class="modal-content">
            <div class="modal-title">Modifier la catégorie</div>
            <div class="form-group">
                <label class="form-label">Nom</label>
                <input type="text" class="form-input" id="editCategoryName">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveEditCategory()">Enregistrer</button>
                <button class="btn btn-secondary" onclick="closeModal('editCategoryModal')">Annuler</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addSubcategoryModal">
        <div class="modal-content">
            <div class="modal-title" id="subModalTitle">Nouvelle Sous-catégorie</div>
            <div class="form-group">
                <label class="form-label">Nom</label>
                <input type="text" class="form-input" id="subcategoryName">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="addSubcategory()">Ajouter</button>
                <button class="btn btn-secondary" onclick="closeModal('addSubcategoryModal')">Annuler</button>
            </div>
        </div>
    </div>

    <div class="modal" id="editSubcategoryModal">
        <div class="modal-content">
            <div class="modal-title">Modifier</div>
            <div class="form-group">
                <label class="form-label">Nom</label>
                <input type="text" class="form-input" id="editSubcategoryName">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveEditSubcategory()">Enregistrer</button>
                <button class="btn btn-secondary" onclick="closeModal('editSubcategoryModal')">Annuler</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addVerseModal">
        <div class="modal-content">
            <div class="modal-title">Nouveau Verset</div>
            <div class="form-group">
                <label class="form-label">Référence</label>
                <input type="text" class="form-input" id="verseRef">
            </div>
            <div class="form-group">
                <label class="form-label">Note</label>
                <input type="text" class="form-input" id="verseNote">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="addVerse()">Ajouter</button>
                <button class="btn btn-secondary" onclick="closeModal('addVerseModal')">Annuler</button>
            </div>
        </div>
    </div>

    <div class="modal" id="editVerseModal">
        <div class="modal-content">
            <div class="modal-title">Modifier le verset</div>
            <div class="form-group">
                <label class="form-label">Référence</label>
                <input type="text" class="form-input" id="editVerseRef">
            </div>
            <div class="form-group">
                <label class="form-label">Note</label>
                <input type="text" class="form-input" id="editVerseNote">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveEditVerse()">Enregistrer</button>
                <button class="btn btn-secondary" onclick="closeModal('editVerseModal')">Annuler</button>
            </div>
        </div>
    </div>

    <div class="page-view" id="subsubPage">
        <div class="page-header">
            <button class="back-btn" onclick="closePage()">←</button>
            <div class="page-title" id="pageTitle"></div>
        </div>
        <div class="page-content" id="pageContent"></div>
    </div>

    <script>
        const STORAGE_KEY = 'monIndexBiblique';
        let data = {categories: [{id: 1, name: 'Foi et Confiance', expanded: true, subcategories: [{id: 11, name: 'Renforcer sa foi', expanded: true, verses: [{id: 111, ref: 'Hébreux 11:1', note: 'Définition de la foi'}], subcategories: []}]}]};
        let currentCat = null, currentSub = null, editItem = null, searchQuery = '', readOnlyMode = false;
        let dragMode = false, draggedItem = null;

        function loadData() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    data = JSON.parse(stored);
                }
            } catch (err) {
                console.error('Erreur lors du chargement des données:', err);
            }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (err) {
                console.error('Erreur lors de la sauvegarde des données:', err);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadData();
            render();
            setTimeout(() => document.getElementById('splash').classList.add('hide'), 1500);
            
            let timeout;
            document.getElementById('searchInput').addEventListener('input', (e) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    searchQuery = e.target.value.toLowerCase().trim();
                    render();
                }, 300);
            });
            document.addEventListener('click', closeContextMenu);
        });

        function closeContextMenu() {
            const existingMenus = document.querySelectorAll('.context-menu');
            existingMenus.forEach(menu => menu.remove());
        }

        function toggleMode() {
            readOnlyMode = !readOnlyMode;
            document.getElementById('modeBtn').textContent = readOnlyMode ? 'Mode Édition' : 'Mode Lecture';
            document.getElementById('controls').classList.toggle('hidden', readOnlyMode);
            if (readOnlyMode) dragMode = false;
            render();
        }

        function toggleDragMode() {
            dragMode = !dragMode;
            closeContextMenu();
            render();
        }

        function showMenu(e, items) {
            e.preventDefault();
            e.stopPropagation();
            
            closeContextMenu();
            
            const div = document.createElement('div');
            div.className = 'context-menu';
            
            items.forEach(item => {
                const itm = document.createElement('div');
                itm.className = 'context-menu-item' + (item.danger ? ' danger' : '');
                itm.textContent = item.label;
                itm.onclick = (ev) => {
                    ev.stopPropagation();
                    closeContextMenu();
                    setTimeout(() => item.action(), 50);
                };
                div.appendChild(itm);
            });
            
            document.body.appendChild(div);
            
            setTimeout(() => {
                const rect = div.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                const viewportWidth = window.innerWidth;
                
                let x = e.pageX || (e.touches && e.touches[0].pageX) || 0;
                let y = e.pageY || (e.touches && e.touches[0].pageY) || 0;
                
                let finalX = Math.max(10, Math.min(x, viewportWidth - rect.width - 10));
                let finalY = y + rect.height > viewportHeight - 10 ? y - rect.height - 10 : y;
                finalY = Math.max(10, finalY);
                
                div.style.left = finalX + 'px';
                div.style.top = finalY + 'px';
            }, 10);
        }

        function highlight(text) {
            if (!searchQuery || !text) return text;
            const regex = new RegExp(`(${searchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function matches(text) {
            if (!text) return !searchQuery;
            return !searchQuery || text.toLowerCase().includes(searchQuery);
        }

        function findSub(catId, subId, parentSubs = null) {
            const cat = data.categories.find(c => c.id === catId);
            if (!cat) return null;
            const subs = parentSubs || cat.subcategories;
            for (let sub of subs) {
                if (sub.id === subId) return sub;
                if (sub.subcategories?.length > 0) {
                    const found = findSub(catId, subId, sub.subcategories);
                    if (found) return found;
                }
            }
            return null;
        }

        function toggleCat(catId) {
            const cat = data.categories.find(c => c.id === catId);
            if (cat) { cat.expanded = !cat.expanded; render(); }
        }

        function toggleSub(catId, subId) {
            const sub = findSub(catId, subId);
            if (sub) { sub.expanded = !sub.expanded; render(); }
        }

        function renderSubs(subs, catId, level = 1, parentPath = '') {
            return subs.map((sub, idx) => {
                const hasMatch = matches(sub.name) || sub.verses.some(v => matches(v.ref) || matches(v.note || ''));
                if (!hasMatch && searchQuery) return '';
                const currentPath = parentPath ? `${parentPath}-${idx}` : `${idx}`;
                
                const onClickAction = level === 2 
                    ? `if(!dragMode)openSubsubPage(${catId}, ${sub.id})` 
                    : `if(!dragMode)toggleSub(${catId}, ${sub.id})`;
                
                return `<div class="subcategory ${level === 2 ? 'level-2' : ''}" data-cat-id="${catId}" data-sub-id="${sub.id}" data-sub-path="${currentPath}" data-level="${level}">
                    <div class="subcategory-header" onclick="${onClickAction}">
                        <div class="subcategory-title-wrapper">
                            ${dragMode ? '<span class="drag-handle" draggable="true">☰</span>' : ''}
                            <div class="subcategory-title">${highlight(sub.name)}</div>
                        </div>
                        <div style="display:flex;align-items:center;gap:12px;">
                            <button class="icon-btn ${readOnlyMode ? 'hidden' : ''}" onclick="event.stopPropagation(); showSubMenu(event, ${catId}, ${sub.id}, ${level})">⋮</button>
                            ${level === 2 ? '<span class="chevron">→</span>' : `<span class="chevron">${sub.expanded ? '▼' : '▶'}</span>`}
                        </div>
                    </div>
                    ${level === 2 ? '' : `<div class="subcategory-content ${sub.expanded ? 'expanded' : ''}">
                        ${sub.subcategories?.length > 0 ? renderSubs(sub.subcategories, catId, level + 1, currentPath) : ''}
                        ${sub.verses.map((v, vIdx) => {
                            const vm = matches(v.ref) || matches(v.note || '');
                            if (!vm && searchQuery) return '';
                            return `<div class="verse-item" data-cat-id="${catId}" data-sub-id="${sub.id}" data-verse-id="${v.id}" data-verse-index="${vIdx}">
                                <div class="verse-content">
                                    ${dragMode ? '<span class="drag-handle" draggable="true">☰</span>' : ''}
                                    <div style="flex:1;">
                                        <a href="https://wol.jw.org/fr/wol/binav/r30/lp-f?q=${encodeURIComponent(v.ref)}" class="verse-ref" target="_blank" onclick="if(dragMode){event.preventDefault();return false;}">${highlight(v.ref)}</a>
                                        ${v.note ? `<div class="verse-note">${highlight(v.note)}</div>` : ''}
                                    </div>
                                </div>
                                <button class="icon-btn ${readOnlyMode ? 'hidden' : ''}" onclick="event.stopPropagation(); showVerseMenu(event, ${catId}, ${sub.id}, ${v.id})">⋮</button>
                            </div>`;
                        }).join('')}
                    </div>`}
                </div>`;
            }).join('');
        }

        function openSubsubPage(catId, subId) {
            if (dragMode) return;
            
            const sub = findSub(catId, subId);
            if (!sub) return;
            
            if (document.getElementById('subsubPage').classList.contains('active')) return;
            
            document.getElementById('pageTitle').textContent = sub.name;
            
            const content = sub.verses.map((v, vIdx) => {
                return `<div class="verse-item" data-cat-id="${catId}" data-sub-id="${sub.id}" data-verse-id="${v.id}" data-verse-index="${vIdx}">
                    <div class="verse-content">
                        <div style="flex:1;">
                            <a href="https://wol.jw.org/fr/wol/binav/r30/lp-f?q=${encodeURIComponent(v.ref)}" class="verse-ref" target="_blank">${v.ref}</a>
                            ${v.note ? `<div class="verse-note">${v.note}</div>` : ''}
                        </div>
                    </div>
                    <button class="icon-btn ${readOnlyMode ? 'hidden' : ''}" onclick="event.stopPropagation(); showVerseMenu(event, ${catId}, ${sub.id}, ${v.id})">⋮</button>
                </div>`;
            }).join('');
            
            document.getElementById('pageContent').innerHTML = content || '<div class="empty-state"><p>Aucun verset</p></div>';
            
            setTimeout(() => {
                document.getElementById('subsubPage').classList.add('active');
            }, 50);
        }

        function closePage() {
            document.getElementById('subsubPage').classList.remove('active');
        }

        function showCatMenu(e, catId) {
            showMenu(e, [
                { label: dragMode ? '✓ Réorganiser' : 'Réorganiser', action: () => toggleDragMode() },
                { label: '+ Sous-catégorie', action: () => openAddSubModal(catId) },
                { label: 'Modifier', action: () => openEditCatModal(catId) },
                { label: 'Supprimer', action: () => deleteCat(catId), danger: true }
            ]);
        }

        function showSubMenu(e, catId, subId, level) {
            const items = [{ label: dragMode ? '✓ Réorganiser' : 'Réorganiser', action: () => toggleDragMode() }];
            if (level < 2) items.push({ label: '+ Sous-sous-catégorie', action: () => openAddSubModal(catId, subId) });
            items.push(
                { label: '+ Verset', action: () => openAddVerseModal(catId, subId) },
                { label: 'Modifier', action: () => openEditSubModal(catId, subId) },
                { label: 'Supprimer', action: () => deleteSub(catId, subId), danger: true }
            );
            showMenu(e, items);
        }

     function showVerseMenu(e, catId, subId, verseId) {
    showMenu(e, [
        { label: dragMode ? '✓ Réorganiser' : 'Réorganiser', action: () => toggleDragMode() },
        { label: 'Modifier', action: () => openEditVerseModal(catId, subId, verseId) },
        { label: 'Supprimer', action: () => deleteVerse(catId, subId, verseId), danger: true }
    ]);
}

function render() {
    const container = document.getElementById('categoriesContainer');
    if (data.categories.length === 0) {
        container.innerHTML = '';
        document.getElementById('emptyState').style.display = 'block';
        return;
    }
    document.getElementById('emptyState').style.display = 'none';
    container.innerHTML = data.categories.map((cat, idx) => {
        const hasMatch = matches(cat.name) || cat.subcategories.some(s => matches(s.name) || s.verses.some(v => matches(v.ref) || matches(v.note || '')));
        if (!hasMatch && searchQuery) return '';
        return `<div class="category-card" data-cat-index="${idx}" data-cat-id="${cat.id}">
            <div class="category-header" onclick="if(!dragMode)toggleCat(${cat.id})">
                <div class="category-title-wrapper">
                    ${dragMode ? '<span class="drag-handle" draggable="true">☰</span>' : ''}
                    <div class="category-title">${highlight(cat.name)}</div>
                </div>
                <div style="display:flex;align-items:center;gap:12px;">
                    <button class="icon-btn ${readOnlyMode ? 'hidden' : ''}" onclick="event.stopPropagation(); showCatMenu(event, ${cat.id})">⋮</button>
                    <span class="chevron">${cat.expanded ? '▼' : '▶'}</span>
                </div>
            </div>
            <div class="category-content ${cat.expanded ? 'expanded' : ''}">
                ${renderSubs(cat.subcategories, cat.id)}
            </div>
        </div>`;
    }).join('');
    
    if (dragMode) setupDragDrop();
}

function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

function getSubcategoryByPath(catId, path) {
    const cat = data.categories.find(c => c.id === catId);
    if (!cat) return null;
    
    const indices = path.split('-').map(n => parseInt(n));
    let current = cat.subcategories;
    let parent = cat.subcategories;
    
    for (let i = 0; i < indices.length; i++) {
        const idx = indices[i];
        if (!current[idx]) return null;
        
        if (i === indices.length - 1) {
            return { parent: parent, index: idx, item: current[idx] };
        } else {
            parent = current[idx].subcategories;
            current = current[idx].subcategories;
        }
    }
    return null;
}

function setupDragDrop() {
    let touchStartY = 0;
    let touchStartX = 0;
    let isDragging = false;
    
    // Catégories
    const catHandles = document.querySelectorAll('.category-card > .category-header .drag-handle');
    catHandles.forEach(handle => {
        const card = handle.closest('.category-card');
        
        // Desktop drag & drop
        handle.setAttribute('draggable', 'true');
        
        handle.addEventListener('dragstart', (e) => {
            draggedItem = { 
                type: 'category', 
                index: parseInt(card.dataset.catIndex)
            };
            e.dataTransfer.effectAllowed = 'move';
            setTimeout(() => card.classList.add('dragging'), 0);
        });
        
        handle.addEventListener('dragend', () => {
            card.classList.remove('dragging');
            draggedItem = null;
        });
        
        // Mobile touch events
        handle.addEventListener('touchstart', (e) => {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
            }
            touchStartY = e.touches[0].clientY;
            touchStartX = e.touches[0].clientX;
            isDragging = true;
            draggedItem = { 
                type: 'category', 
                index: parseInt(card.dataset.catIndex)
            };
            card.classList.add('dragging');
        });
        
        handle.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            card.classList.remove('dragging');
            
            const touch = e.changedTouches[0];
            const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
            const targetCard = dropTarget?.closest('.category-card');
            
            if (targetCard && draggedItem?.type === 'category') {
                const toIndex = parseInt(targetCard.dataset.catIndex);
                const fromIndex = draggedItem.index;
                if (fromIndex !== toIndex) {
                    const [moved] = data.categories.splice(fromIndex, 1);
                    data.categories.splice(toIndex, 0, moved);
                    saveData();
                    render();
                }
            }
            
            draggedItem = null;
            isDragging = false;
        });
    });
    
    const cats = document.querySelectorAll('.category-card');
    cats.forEach(card => {
        card.addEventListener('dragover', (e) => {
            if (draggedItem?.type === 'category') {
                e.preventDefault();
            }
        });
        
        card.addEventListener('drop', (e) => {
            e.preventDefault();
            if (draggedItem?.type === 'category') {
                const toIndex = parseInt(card.dataset.catIndex);
                const fromIndex = draggedItem.index;
                if (fromIndex !== toIndex) {
                    const [moved] = data.categories.splice(fromIndex, 1);
                    data.categories.splice(toIndex, 0, moved);
                    saveData();
                    render();
                }
            }
        });
    });

    // Sous-catégories
    const subHandles = document.querySelectorAll('.subcategory > .subcategory-header .drag-handle');
    subHandles.forEach(handle => {
        const subDiv = handle.closest('.subcategory');
        
        // Desktop drag & drop
        handle.setAttribute('draggable', 'true');
        
        handle.addEventListener('dragstart', (e) => {
            draggedItem = { 
                type: 'subcategory', 
                catId: parseInt(subDiv.dataset.catId),
                path: subDiv.dataset.subPath,
                level: parseInt(subDiv.dataset.level)
            };
            e.dataTransfer.effectAllowed = 'move';
            setTimeout(() => subDiv.classList.add('dragging'), 0);
        });
        
        handle.addEventListener('dragend', () => {
            subDiv.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            draggedItem = null;
        });
        
        // Mobile touch events
        handle.addEventListener('touchstart', (e) => {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
            }
            touchStartY = e.touches[0].clientY;
            touchStartX = e.touches[0].clientX;
            isDragging = true;
            draggedItem = { 
                type: 'subcategory', 
                catId: parseInt(subDiv.dataset.catId),
                path: subDiv.dataset.subPath,
                level: parseInt(subDiv.dataset.level)
            };
            subDiv.classList.add('dragging');
        });
        
        handle.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            subDiv.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            
            const touch = e.changedTouches[0];
            const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
            const targetSubDiv = dropTarget?.closest('.subcategory');
            
            if (targetSubDiv && draggedItem?.type === 'subcategory') {
                const toCatId = parseInt(targetSubDiv.dataset.catId);
                const toPath = targetSubDiv.dataset.subPath;
                const toLevel = parseInt(targetSubDiv.dataset.level);
                
                if (draggedItem.catId === toCatId && draggedItem.level === toLevel && draggedItem.path !== toPath) {
                    const fromData = getSubcategoryByPath(draggedItem.catId, draggedItem.path);
                    const toData = getSubcategoryByPath(toCatId, toPath);
                    
                    if (fromData && toData && fromData.parent === toData.parent) {
                        const [moved] = fromData.parent.splice(fromData.index, 1);
                        const adjustedIndex = fromData.index < toData.index ? toData.index : toData.index;
                        fromData.parent.splice(adjustedIndex, 0, moved);
                        saveData();
                        render();
                    }
                }
            }
            
            draggedItem = null;
            isDragging = false;
        });
    });
    
    const subs = document.querySelectorAll('.subcategory');
    subs.forEach(subDiv => {
        subDiv.addEventListener('dragover', (e) => {
            if (draggedItem?.type === 'subcategory') {
                const targetCatId = parseInt(subDiv.dataset.catId);
                const targetLevel = parseInt(subDiv.dataset.level);
                if (draggedItem.catId === targetCatId && draggedItem.level === targetLevel) {
                    e.preventDefault();
                    subDiv.classList.add('drag-over');
                }
            }
        });
        
        subDiv.addEventListener('dragleave', () => {
            subDiv.classList.remove('drag-over');
        });
        
        subDiv.addEventListener('drop', (e) => {
            e.preventDefault();
            subDiv.classList.remove('drag-over');
            
            if (draggedItem?.type === 'subcategory') {
                const toCatId = parseInt(subDiv.dataset.catId);
                const toPath = subDiv.dataset.subPath;
                const toLevel = parseInt(subDiv.dataset.level);
                
                if (draggedItem.catId === toCatId && draggedItem.level === toLevel && draggedItem.path !== toPath) {
                    const fromData = getSubcategoryByPath(draggedItem.catId, draggedItem.path);
                    const toData = getSubcategoryByPath(toCatId, toPath);
                    
                    if (fromData && toData && fromData.parent === toData.parent) {
                        const [moved] = fromData.parent.splice(fromData.index, 1);
                        const adjustedIndex = fromData.index < toData.index ? toData.index : toData.index;
                        fromData.parent.splice(adjustedIndex, 0, moved);
                        saveData();
                        render();
                    }
                }
            }
        });
    });

    // Versets
    const verseHandles = document.querySelectorAll('.verse-item .drag-handle');
    verseHandles.forEach(handle => {
        const verseDiv = handle.closest('.verse-item');
        
        // Desktop drag & drop
        handle.setAttribute('draggable', 'true');
        
        handle.addEventListener('dragstart', (e) => {
            draggedItem = {
                type: 'verse',
                catId: parseInt(verseDiv.dataset.catId),
                subId: parseInt(verseDiv.dataset.subId),
                verseId: parseInt(verseDiv.dataset.verseId),
                index: parseInt(verseDiv.dataset.verseIndex)
            };
            e.dataTransfer.effectAllowed = 'move';
            setTimeout(() => verseDiv.classList.add('dragging'), 0);
        });
        
        handle.addEventListener('dragend', () => {
            verseDiv.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            draggedItem = null;
        });
        
        // Mobile touch events
        handle.addEventListener('touchstart', (e) => {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
            }
            touchStartY = e.touches[0].clientY;
            touchStartX = e.touches[0].clientX;
            isDragging = true;
            draggedItem = {
                type: 'verse',
                catId: parseInt(verseDiv.dataset.catId),
                subId: parseInt(verseDiv.dataset.subId),
                verseId: parseInt(verseDiv.dataset.verseId),
                index: parseInt(verseDiv.dataset.verseIndex)
            };
            verseDiv.classList.add('dragging');
        });
        
        handle.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            verseDiv.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            
            const touch = e.changedTouches[0];
            const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
            const targetVerseDiv = dropTarget?.closest('.verse-item');
            
            if (targetVerseDiv && draggedItem?.type === 'verse') {
                const toCatId = parseInt(targetVerseDiv.dataset.catId);
                const toSubId = parseInt(targetVerseDiv.dataset.subId);
                const toIndex = parseInt(targetVerseDiv.dataset.verseIndex);
                
                if (draggedItem.catId === toCatId && draggedItem.subId === toSubId && draggedItem.index !== toIndex) {
                    const sub = findSub(toCatId, toSubId);
                    if (sub) {
                        const [moved] = sub.verses.splice(draggedItem.index, 1);
                        sub.verses.splice(toIndex, 0, moved);
                        saveData();
                        render();
                    }
                }
            }
            
            draggedItem = null;
            isDragging = false;
        });
    });
    
    const verses = document.querySelectorAll('.verse-item');
    verses.forEach(verseDiv => {
        verseDiv.addEventListener('dragover', (e) => {
            if (draggedItem?.type === 'verse') {
                const targetCatId = parseInt(verseDiv.dataset.catId);
                const targetSubId = parseInt(verseDiv.dataset.subId);
                if (draggedItem.catId === targetCatId && draggedItem.subId === targetSubId) {
                    e.preventDefault();
                    verseDiv.classList.add('drag-over');
                }
            }
        });
        
        verseDiv.addEventListener('dragleave', () => {
            verseDiv.classList.remove('drag-over');
        });
        
        verseDiv.addEventListener('drop', (e) => {
            e.preventDefault();
            verseDiv.classList.remove('drag-over');
            
            if (draggedItem?.type === 'verse') {
                const toCatId = parseInt(verseDiv.dataset.catId);
                const toSubId = parseInt(verseDiv.dataset.subId);
                const toIndex = parseInt(verseDiv.dataset.verseIndex);
                
                if (draggedItem.catId === toCatId && draggedItem.subId === toSubId && draggedItem.index !== toIndex) {
                    const sub = findSub(toCatId, toSubId);
                    if (sub) {
                        const [moved] = sub.verses.splice(draggedItem.index, 1);
                        sub.verses.splice(toIndex, 0, moved);
                        saveData();
                        render();
                    }
                }
            }
        });
    });
}

function addCategory() {
    const name = document.getElementById('categoryName').value.trim();
    if (!name) return;
    data.categories.push({ id: Date.now(), name, expanded: true, subcategories: [] });
    saveData();
    render();
    closeModal('addCategoryModal');
    document.getElementById('categoryName').value = '';
}

function openEditCatModal(catId) {
    editItem = { type: 'cat', id: catId };
    const cat = data.categories.find(c => c.id === catId);
    document.getElementById('editCategoryName').value = cat.name;
    openModal('editCategoryModal');
}

function saveEditCategory() {
    const cat = data.categories.find(c => c.id === editItem.id);
    if (cat) { cat.name = document.getElementById('editCategoryName').value.trim(); saveData(); render(); }
    closeModal('editCategoryModal');
}

function openAddSubModal(catId, parentSubId = null) {
    currentCat = catId;
    currentSub = parentSubId;
    document.getElementById('subcategoryName').value = '';
    document.getElementById('subModalTitle').textContent = parentSubId ? 'Nouvelle Sous-sous-catégorie' : 'Nouvelle Sous-catégorie';
    openModal('addSubcategoryModal');
}

function addSubcategory() {
    const name = document.getElementById('subcategoryName').value.trim();
    if (!name) return;
    if (currentSub) {
        const parentSub = findSub(currentCat, currentSub);
        if (parentSub) {
            if (!parentSub.subcategories) parentSub.subcategories = [];
            parentSub.subcategories.push({ id: Date.now(), name, expanded: true, verses: [], subcategories: [] });
        }
    } else {
        const cat = data.categories.find(c => c.id === currentCat);
        if (cat) cat.subcategories.push({ id: Date.now(), name, expanded: true, verses: [], subcategories: [] });
    }
    saveData();
    render();
    closeModal('addSubcategoryModal');
}

function openEditSubModal(catId, subId) {
    editItem = { type: 'sub', catId, id: subId };
    const sub = findSub(catId, subId);
    if (sub) {
        document.getElementById('editSubcategoryName').value = sub.name;
        openModal('editSubcategoryModal');
    }
}

function saveEditSubcategory() {
    const sub = findSub(editItem.catId, editItem.id);
    if (sub) { sub.name = document.getElementById('editSubcategoryName').value.trim(); saveData(); render(); }
    closeModal('editSubcategoryModal');
}

function openAddVerseModal(catId, subId) {
    currentCat = catId;
    currentSub = subId;
    document.getElementById('verseRef').value = '';
    document.getElementById('verseNote').value = '';
    openModal('addVerseModal');
}

function addVerse() {
    const ref = document.getElementById('verseRef').value.trim();
    const note = document.getElementById('verseNote').value.trim();
    if (!ref) return;
    const sub = findSub(currentCat, currentSub);
    if (sub) { sub.verses.push({ id: Date.now(), ref, note }); saveData(); render(); }
    closeModal('addVerseModal');
}

function openEditVerseModal(catId, subId, verseId) {
    editItem = { type: 'verse', catId, subId, id: verseId };
    const sub = findSub(catId, subId);
    if (sub) {
        const verse = sub.verses.find(v => v.id === verseId);
        if (verse) {
            document.getElementById('editVerseRef').value = verse.ref;
            document.getElementById('editVerseNote').value = verse.note || '';
            openModal('editVerseModal');
        }
    }
}

function saveEditVerse() {
    const sub = findSub(editItem.catId, editItem.subId);
    if (sub) {
        const verse = sub.verses.find(v => v.id === editItem.id);
        if (verse) {
            verse.ref = document.getElementById('editVerseRef').value.trim();
            verse.note = document.getElementById('editVerseNote').value.trim();
            saveData();
            render();
        }
    }
    closeModal('editVerseModal');
}

function deleteCat(catId) {
    if (confirm('Supprimer cette catégorie ?')) {
        data.categories = data.categories.filter(c => c.id !== catId);
        saveData();
        render();
    }
}

function deleteSubRec(subs, subId) {
    for (let i = 0; i < subs.length; i++) {
        if (subs[i].id === subId) { subs.splice(i, 1); return true; }
        if (subs[i].subcategories?.length > 0 && deleteSubRec(subs[i].subcategories, subId)) return true;
    }
    return false;
}

function deleteSub(catId, subId) {
    if (confirm('Supprimer cette sous-catégorie ?')) {
        const cat = data.categories.find(c => c.id === catId);
        if (cat) { deleteSubRec(cat.subcategories, subId); saveData(); render(); }
    }
}

function deleteVerse(catId, subId, verseId) {
    const sub = findSub(catId, subId);
    if (sub) { sub.verses = sub.verses.filter(v => v.id !== verseId); saveData(); render(); }
}

function exportData() {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `index-biblique-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
}

function importData(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                data = JSON.parse(ev.target.result);
                saveData();
                render();
                alert('✅ Données importées avec succès !');
            } catch (err) {
                alert('❌ Erreur lors de l\'import');
            }
        };
        reader.readAsText(file);
    }
}
    </script>
</body>
</html>
